{% extends 'users/base.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div id="wrapper">
    {% include 'admin_panel/includes/admin_sidebar.html' %}

    <div class="main-content" id="main-content" style="margin-top:60px;">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
            <div class="container-fluid px-4 py-2">
                <button class="btn btn-outline-secondary d-md-none me-3" id="mobileToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h4 class="mb-0 text-primary">Admin Dashboard</h4>
                <div class="d-flex align-items-center">
                    <span class="me-3 text-muted d-none d-md-block">
                        <i class="fas fa-calendar-day me-1"></i>
                        <span id="current-date">{{ current_date|default:"Today" }}</span>
                    </span>
                    <button class="btn btn-outline-primary btn-sm position-relative">
                        <i class="fas fa-bell"></i>
                        {% if pending_feedback > 0 %}
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                            {{ pending_feedback|default:"0" }}
                            <span class="visually-hidden">unread notifications</span>
                        </span>
                        {% endif %}
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="content-body p-1 p-md-4">
            <!-- Welcome Card -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow border-0">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h3 class="text-primary mb-2">
                                        <i class="fas fa-user-shield me-2"></i>Welcome, {{ request.user.username }}!
                                    </h3>
                                    <p class="text-muted mb-0">
                                        You're managing {{ total_policies|default:"0" }} policies,
                                        {{ active_claims|default:"0" }} active claims, and
                                        {{ pending_feedback|default:"0" }} pending feedback tickets.
                                    </p>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <div class="d-flex align-items-center justify-content-md-end">
                                        <div class="avatar-lg bg-primary rounded-circle d-flex align-items-center justify-content-center me-3">
                                            <i class="fas fa-user-cog text-white fa-2x"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-0">{{ request.user.get_full_name|default:"Administrator" }}</h5>
                                            <small class="text-muted">
                                                Last login: {{ request.user.last_login|date:"M d, Y H:i"|default:"First time" }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                        Total Policies
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        {{ total_policies|default:"0" }}
                                    </div>
                                    <div class="mt-2">
                                        {% if policy_growth and policy_growth > 0 %}
                                        <span class="text-success small font-weight-bold">
                                            <i class="fas fa-arrow-up me-1"></i>{{ policy_growth }}%
                                        </span>
                                        {% elif policy_growth and policy_growth < 0 %}
                                        <span class="text-danger small font-weight-bold">
                                            <i class="fas fa-arrow-down me-1"></i>
                                            {% widthratio policy_growth 1 -1 %}%
                                        </span>
                                        {% else %}
                                        <span class="text-muted small font-weight-bold">
                                            <i class="fas fa-minus me-1"></i>0%
                                        </span>
                                        {% endif %}
                                        <span class="text-muted small">from last month</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-file-contract fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-top-0">
                            <a href="{% url 'admin_panel:admin_policy_management' %}" class="text-decoration-none small">
                                View Details <i class="fas fa-arrow-circle-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Active Claims
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        {{ active_claims|default:"0" }}
                                    </div>
                                    <div class="mt-2">
                                        {% if pending_review_claims and pending_review_claims > 0 %}
                                        <span class="text-warning small font-weight-bold">
                                            <i class="fas fa-clock me-1"></i>{{ pending_review_claims }} pending
                                        </span>
                                        {% else %}
                                        <span class="text-success small font-weight-bold">
                                            <i class="fas fa-check me-1"></i>All processed
                                        </span>
                                        {% endif %}
                                        <span class="text-muted small">review</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-file-medical fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-top-0">
                            <a href="{% url 'admin_panel:admin_claims' %}" class="text-decoration-none small">
                                View Details <i class="fas fa-arrow-circle-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Pending Feedback
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        {{ pending_feedback|default:"0" }}
                                    </div>
                                    <div class="mt-2">
                                        {% if urgent_feedback and urgent_feedback > 0 %}
                                        <span class="text-danger small font-weight-bold">
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ urgent_feedback }} urgent
                                        </span>
                                        {% else %}
                                        <span class="text-success small font-weight-bold">
                                            <i class="fas fa-check me-1"></i>No urgent
                                        </span>
                                        {% endif %}
                                        <span class="text-muted small">needs attention</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-headset fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-top-0">
                            <a href="{% url 'admin_panel:feedback_dashboard' %}" class="text-decoration-none small">
                                View Details <i class="fas fa-arrow-circle-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        Total Revenue
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        ₹
                                        {% if total_revenue %}
                                            {{ total_revenue|floatformat:"0" }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </div>
                                    <div class="mt-2">
                                        {% if revenue_growth and revenue_growth > 0 %}
                                        <span class="text-success small font-weight-bold">
                                            <i class="fas fa-arrow-up me-1"></i>{{ revenue_growth }}%
                                        </span>
                                        {% elif revenue_growth and revenue_growth < 0 %}
                                        <span class="text-danger small font-weight-bold">
                                            <i class="fas fa-arrow-down me-1"></i>
                                            {% with revenue_growth|stringformat:"s"|slice:"1:" as abs_growth %}
                                                {{ abs_growth }}%
                                            {% endwith %}
                                        </span>
                                        {% else %}
                                        <span class="text-muted small font-weight-bold">
                                            <i class="fas fa-minus me-1"></i>0%
                                        </span>
                                        {% endif %}
                                        <span class="text-muted small">from last month</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-rupee-sign fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-top-0">
                            <a href="#" class="text-decoration-none small">
                                View Details <i class="fas fa-arrow-circle-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions and Recent Activity -->
            <div class="row">
                <!-- Quick Actions -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow border-0">
                        <div class="card-header bg-white py-3">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-bolt me-2"></i>Quick Actions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <a href="{% url 'admin_panel:admin_policy_management' %}" class="card action-card text-decoration-none">
                                        <div class="card-body text-center p-4">
                                            <div class="action-icon mb-3">
                                                <i class="fas fa-plus-circle fa-2x text-primary"></i>
                                            </div>
                                            <h6 class="card-title mb-2">Add New Policy</h6>
                                            <p class="card-text text-muted small">Create and publish new insurance policy</p>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    {% if pending_review_claims > 0 %}
                                    <a href="{% url 'admin_panel:admin_claims' %}?status=submitted" class="card action-card text-decoration-none">
                                    {% else %}
                                    <a href="{% url 'admin_panel:admin_claims' %}" class="card action-card text-decoration-none">
                                    {% endif %}
                                        <div class="card-body text-center p-4">
                                            <div class="action-icon mb-3">
                                                <i class="fas fa-search fa-2x text-success"></i>
                                            </div>
                                            <h6 class="card-title mb-2">
                                                {% if pending_review_claims > 0 %}
                                                Review Claims ({{ pending_review_claims }})
                                                {% else %}
                                                Review Claims
                                                {% endif %}
                                            </h6>
                                            <p class="card-text text-muted small">Process pending insurance claims</p>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    {% if pending_feedback > 0 %}
                                    <a href="{% url 'admin_panel:feedback_dashboard' %}" class="card action-card text-decoration-none">
                                    {% else %}
                                    <a href="{% url 'admin_panel:feedback_dashboard' %}" class="card action-card text-decoration-none">
                                    {% endif %}
                                        <div class="card-body text-center p-4">
                                            <div class="action-icon mb-3">
                                                <i class="fas fa-comments fa-2x text-warning"></i>
                                            </div>
                                            <h6 class="card-title mb-2">
                                                {% if pending_feedback > 0 %}
                                                Respond to Feedback ({{ pending_feedback }})
                                                {% else %}
                                                Respond to Feedback
                                                {% endif %}
                                            </h6>
                                            <p class="card-text text-muted small">Address customer feedback and support tickets</p>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <a href="#" class="card action-card text-decoration-none">
                                        <div class="card-body text-center p-4">
                                            <div class="action-icon mb-3">
                                                <i class="fas fa-chart-line fa-2x text-info"></i>
                                            </div>
                                            <h6 class="card-title mb-2">Generate Report</h6>
                                            <p class="card-text text-muted small">Create analytical reports</p>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow border-0 h-100">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-history me-2"></i>Recent Activity
                            </h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="activity-timeline">
                                {% for activity in recent_activities %}
                                <div class="activity-item">
                                    <div class="activity-icon {{ activity.color }}">
                                        <i class="fas {{ activity.icon }}"></i>
                                    </div>
                                    <div class="activity-content">
                                        <h6 class="mb-1">{{ activity.title }}</h6>
                                        <p class="mb-0 text-muted small">{{ activity.description }}</p>
                                        <small class="text-muted">
                                            <i class="far fa-clock me-1"></i>{{ activity.time|timesince }} ago
                                        </small>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center py-5">
                                    <i class="fas fa-history fa-2x text-muted mb-3"></i>
                                    <p class="text-muted mb-0">No recent activity</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Claims and Feedback -->
            <div class="row">
                <!-- Recent Claims -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow border-0">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-file-medical me-2"></i>Recent Claims
                            </h5>
                            <a href="{% url 'admin_panel:admin_claims' %}" class="btn btn-sm btn-outline-primary">
                                View All ({{ total_claims|default:"0" }})
                            </a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Claim ID</th>
                                            <th>User</th>
                                            <th>Status</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for claim in recent_claims %}
                                        <tr>
                                            <td class="fw-bold">{{ claim.claim_id|default:"N/A" }}</td>
                                            <td>{{ claim.user_policy.user.username|default:"N/A" }}</td>
                                            <td>
                                                {% if claim.status == 'APPROVED' or claim.status == 'Approved' %}
                                                <span class="badge bg-success">Approved</span>
                                                {% elif claim.status == 'REJECTED' or claim.status == 'Rejected' %}
                                                <span class="badge bg-danger">Rejected</span>
                                                {% elif claim.status == 'UNDER_REVIEW' or claim.status == 'Under Review' %}
                                                <span class="badge bg-warning">Under Review</span>
                                                {% elif claim.status == 'SUBMITTED' or claim.status == 'Submitted' %}
                                                <span class="badge bg-info">Submitted</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ claim.status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>₹ {{ claim.claim_amount|default:"0" }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center py-4 text-muted">
                                                <i class="fas fa-inbox fa-2x mb-3"></i>
                                                <p>No recent claims found</p>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Feedback -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow border-0">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-comments me-2"></i>Recent Feedback
                            </h5>
                            <a href="{% url 'admin_panel:feedback_dashboard' %}" class="btn btn-sm btn-outline-primary">
                                View All ({{ pending_feedback|default:"0" }} open)
                            </a>
                        </div>
                        <div class="card-body p-0">
                            <div class="feedback-list">
                                {% for feedback in recent_feedback %}
                                <div class="feedback-item p-3 {% if not forloop.last %}border-bottom{% endif %}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div style="max-width: 75%;">
                                            <h6 class="mb-1 text-truncate">{{ feedback.subject|default:"No Subject" }}</h6>
                                            <p class="mb-1 text-muted small text-truncate">
                                                {{ feedback.description|truncatechars:80 }}
                                            </p>
                                            <small class="text-muted">
                                                <i class="far fa-user me-1"></i>
                                                {{ feedback.created_by.username|default:"Unknown User" }}
                                            </small>
                                        </div>
                                        <div>
                                            {% if feedback.status == 'Open' %}
                                            <span class="badge bg-warning">Open</span>
                                            {% elif feedback.status == 'Under Review' %}
                                            <span class="badge bg-info">Under Review</span>
                                            {% elif feedback.status == 'Closed' %}
                                            <span class="badge bg-success">Closed</span>
                                            {% else %}
                                            <span class="badge bg-secondary">{{ feedback.status }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center py-5">
                                    <i class="fas fa-comments fa-2x text-muted mb-3"></i>
                                    <p class="text-muted mb-0">No recent feedback</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Stats Summary -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card shadow border-0">
                        <div class="card-header bg-white py-3">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-chart-pie me-2"></i>System Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="p-3">
                                        <h3 class="text-primary mb-2">{{ total_users|default:"0" }}</h3>
                                        <p class="text-muted mb-0">Total Users</p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="p-3">
                                        <h3 class="text-success mb-2">{{ total_claims|default:"0" }}</h3>
                                        <p class="text-muted mb-0">Total Claims</p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="p-3">
                                        <h3 class="text-warning mb-2">{{ approved_claims|default:"0" }}</h3>
                                        <p class="text-muted mb-0">Approved Claims</p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="p-3">
                                        <h3 class="text-danger mb-2">{{ rejected_claims|default:"0" }}</h3>
                                        <p class="text-muted mb-0">Rejected Claims</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* (Keep all the CSS styles from the original template - they remain the same) */
    /* ... All your existing CSS styles ... */
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update current date in real-time
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                dateElement.textContent = dateString;
            }
        }

        // Initialize
        updateCurrentDate();

        // Mobile sidebar toggle
        const mobileToggle = document.getElementById('mobileToggle');
        if (mobileToggle) {
            mobileToggle.addEventListener('click', function() {
                document.getElementById('wrapper').classList.toggle('toggled');
            });
        }

        // Auto-refresh data every 5 minutes
        setInterval(function() {
            // You can implement AJAX refresh here if needed
            console.log('Auto-refresh triggered at', new Date().toLocaleTimeString());
        }, 300000); // 5 minutes

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile-view');
            } else {
                document.body.classList.remove('mobile-view');
            }
        });

        // Initialize on load
        if (window.innerWidth <= 768) {
            document.body.classList.add('mobile-view');
        }
    });
</script>
{% endblock %}